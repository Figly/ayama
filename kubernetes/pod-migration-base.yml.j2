---
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    app: "{{ app }}"
    run: "{{ app }}-migration"
    environment: "{{ environment }}"
{%- for label, value in defaults.get('labels', {}).items() %}
    {{ label }}: "{{ value }}"
{%- endfor %}
  name: "{{ app }}-migration"
spec:
  restartPolicy: Never
  containers:
    - image: "{{ image_url }}"
      name: "{{ app }}-migration"
      args:
        - python
        - manage.py
        - migrate
      resources: {}
      volumeMounts:
        - mountPath: /etc/gcloud/
          name: credentials
          readOnly: true
{%- if environment == 'dev' %}
        - mountPath: /usr/src/app
          name: app
{%- endif %}
      env:
        - name: NEW_RELIC_APP_NAME
          value: {{ app }}
        - name: ENVIRONMENT
          value: {{ environment }}
      envFrom:
      - configMapRef:
          name: {{ app }}-env
      - secretRef:
          name: {{ app }}-env
  volumes:
    - name: credentials
      secret:
        secretName: ayama-credentials
{%- if environment == 'dev' %}
    - name: app
      hostPath:
        path: "{{ source_path }}/src"
{%- endif %}
status: {}
