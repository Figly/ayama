{% load i18n %}

{% block content %}
{% block container %}
{% comment %} <h3>Client List</h3> {% endcomment %}
{% if clients %}
<div class="table_detail_rows">
    <table class="table">
        <tr>
            <th scope="col">Name
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                    <path
                        d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                </svg>
            </th>
            {%if user.is_superuser %}
            <th scope="col">Email</th>
            {% endif %}
            {%if user.is_administrator %}
            <th scope="col">Advisor</th>
            {% endif %}
            <th scope="col">Email <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                    <path
                        d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                </svg></th>
            <th scope="col">Cellphone </th>
            <th scope="col">Location</th>
            <th scope="col">Last Contact</th>
            <th scope="col">Status</th>
        </tr>

                {%if user.is_superuser %}
                <th scope="col">Email</th>
                {% endif %}
                {%if user.is_administrator %}
                <th scope="col">Advisor</th>
                {% endif %}
                <th scope="col">Email</th>
                <th scope="col">Location</th>
                <th scope="col">Last contact </th>
                <th scope="col">Status</th>
            </tr>
        </thead>
        {% load client_status %}
        {% for client in clients %}
        <tbody>
            <tr scope="row" data-href="{% url 'clients:client-summary' pk=client.id %}">

                <td><a href="{% url 'clients:client-summary' pk=client.id %}">{{ client.names }}
                        {{ client.surnames }}</a>
                </td>
                {% comment %} <td>{{ client.advisor_id_fk}} </td> {% endcomment %}

                <td> <a href="{% url 'clients:client-summary' pk=client.id %}">{{ client.client_contact_fk.email_address }}
                    </a></td>
                </td>
                <td> <a href="{% url 'clients:client-summary' pk=client.id %}">{{ client.client_contact_fk.residential_address_line_1 }}
                    </a></td>
                </td>
                <td>
                    <input class="datepicker" id={{client.client_comms_fk.id}} date-format='yyyy-mm-dd' value = "{{ client.client_comms_fk.last_contacted }}">
                    <button class="btn" onclick="updateComms(this)" role="button" data-id={{client.client_comms_fk.id}}>update</button>
                </td>
                </td>
                <td> <a href="{% url 'clients:client-summary' pk=client.id %}">{% client_status client.client_comms_fk.last_contacted %}
                    </a>
                </td>
                {% if user.is_superuser %}
                <td>{{ client.advisor_id_fk.practise_id_fk}}</td>
                <td>{{ client.advisor_id_fk}}</td>
                {% endif %}
                {%if user.is_administrator %}
                <td>{{client.employment_date}}</td>

                {% endif %}
            </tr>

        </tbody>
        {% endfor %}
    </table>
</div>
{% else %}
<p>No Clients to Display</p>
{% endif %}
{% endblock %}
{% endblock %}

{% block scripts %}
  <script>
function updateComms(e){
    var client_comms_id = e.getAttribute('data-id');
    var dateValue = convertDate(new Date(document.getElementById(client_comms_id).value));
    $.ajax({
        type: 'POST',
        headers:{
        "X-CSRFToken": '{{ csrf_token }}'
        },
        url: "{% url 'clients:update-comms'%}",
        data: {'client_comms_id':client_comms_id, 'date_value': dateValue},
        success: function (response) {
            e.value = dateValue
        },
        error: function (response) {
        }
    });
}
function convertDate(date) {
  var yyyy = date.getFullYear().toString();
  var mm = (date.getMonth()+1).toString();
  var dd  = date.getDate().toString();

  var mmChars = mm.split('');
  var ddChars = dd.split('');

  return yyyy + '-' + (mmChars[1]?mm:"0"+mmChars[0]) + '-' + (ddChars[1]?dd:"0"+ddChars[0]);
}
</script>
{% endblock %}
